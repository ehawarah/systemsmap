<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>All System Connections</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');
  
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    background: #0d0d1a;
    font-family: 'DM Sans', sans-serif;
    color: #e0e0e0;
    overflow: hidden;
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  #page-frame {
    position: relative;
    width: 100vw;
    height: 56.25vw; /* 16:9 */
    max-height: 100vh;
    max-width: 177.78vh; /* 16:9 inverse */
    background: #0d0d1a;
    overflow: hidden;
  }

  /* ── HEADER BAR ── matches Power BI template */
  .header-bar {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 48px;
    display: flex;
    align-items: center;
    padding: 0 24px;
    z-index: 60;
    background: linear-gradient(180deg, #111126 0%, #0d0d1aee 100%);
  }
  .header-bar h1 {
    font-size: 15px;
    font-weight: 700;
    color: #e0e0e0;
    letter-spacing: 0.02em;
  }
  .header-accent {
    width: 10px;
    height: 10px;
    background: #E8735A;
    border-radius: 50%;
    margin-right: 10px;
    flex-shrink: 0;
  }

  /* ── CONTROLS ── styled to match Power BI filter pills */
  .controls {
    position: absolute;
    top: 8px;
    right: 20px;
    display: flex;
    gap: 6px;
    z-index: 60;
    align-items: center;
    height: 48px;
  }
  .controls select { display: none; }
  .controls button {
    background: #16162a;
    color: #bbb;
    border: 1px solid #2a2a44;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 11px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
    white-space: nowrap;
  }
  .controls button:hover { background: #1e1e38; border-color: #3a3a5a; }
  .controls button.active { background: #e8735a22; border-color: #e8735a66; color: #E8735A; }

  /* ── SVG CANVAS ── */
  #canvas-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }
  svg { width: 100%; height: 100%; display: block; }

  /* ── TOOLTIP ── */
  .tooltip {
    position: fixed;
    pointer-events: none;
    background: #13132aee;
    border: 1px solid #2a2a44;
    border-radius: 4px;
    padding: 10px 14px;
    font-size: 11px;
    line-height: 1.6;
    max-width: 280px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 100;
  }
  .tooltip.visible { opacity: 1; }
  .tooltip .tt-name { font-weight: 700; font-size: 12px; margin-bottom: 3px; }
  .tooltip .tt-cat { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.5; margin-bottom: 5px; }
  .tooltip .tt-row { display: flex; justify-content: space-between; gap: 10px; }
  .tooltip .tt-label { color: #777; }
  .tooltip .tt-val { font-weight: 600; }
  .tooltip .tt-req { color: #E8735A; font-weight: 600; font-size: 10px; margin-top: 4px; }

  /* ── LEGEND ── */
  .legend {
    position: absolute;
    bottom: 12px;
    left: 16px;
    background: #111126dd;
    border: 1px solid #2a2a44;
    border-radius: 4px;
    padding: 10px 14px;
    font-size: 10px;
    z-index: 50;
  }
  .legend-title {
    font-size: 8px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: #555;
    margin-bottom: 6px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 1.5px 0;
    color: #999;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .legend-item:hover { opacity: 1; color: #ccc; }
  .legend-item .swatch {
    width: 8px;
    height: 8px;
    border-radius: 2px;
    flex-shrink: 0;
  }


  .hex-node { transition: opacity 0.3s; cursor: pointer; }
  .hex-node:hover { filter: brightness(1.3); }
  .connection-line { transition: opacity 0.3s; }
</style>
</head>
<body>
<div id="page-frame">

  <div id="canvas-container">
    <svg id="main-svg"></svg>
  </div>
  <div class="legend" id="legend"></div>

  <div class="tooltip" id="tooltip"></div>
</div>

<script>
// ─── PARSE CSV DATA ──────────────────────────────────────────────
const CSV_RAW = `System Name / ID,OWNER,Category,Required Connections to Other Systems
Building Automation System (BAS),Gautham Sunkara,Core Building Autonomy (MEP & Energy),
UPS Monitoring,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Heat Recovery Chiller,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Variable Frequency Drives,Gautham Sunkara,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Digital Integration Platform,,Digital Integration & Platform,"Building Automation System (BAS), robotics, specialized lab equipment, environmental controls, building systems, vivarium environments, and logistics operations"
Independent Data Layer (IDL),,Digital Integration & Platform,Digital Integration Platform
Analytics & Insights,,Digital Integration & Platform,Digital Integration Platform
Event Management and Rule Execution,,Digital Integration & Platform,"external workflow and ticketing platforms"
Cognitive Automation and Agentic AI,,Digital Integration & Platform,"Third-party AI frameworks or APIs"
Cyber Security & Resilience,,Digital Integration & Platform,"Single Sign-On (SSO), Active Directory"
AV Systems,,Workplace Experience & Logistics,
Digital Signage Systems,,Workplace Experience & Logistics,
IPTV and Digital Distribution Systems,,Workplace Experience & Logistics,
Video Conference System,,Workplace Experience & Logistics,
Room Scheduling Systems,,Workplace Experience & Logistics,
Custom Video Wall Systems,,Workplace Experience & Logistics,
Flexible Interconnect AV Distribution System,,Workplace Experience & Logistics,
Water-Based Fire-Suppression Water Supply,,,
Wet Pipe Sprinkler System,Michael Harris,Core Building Autonomy (MEP & Energy),Fire alarm system
Preaction Sprinkler System,Melissa Chong,Core Building Autonomy (MEP & Energy),Fire alarm system
Clean Agent Fire Extinguishing System,Melissa Chong,Core Building Autonomy (MEP & Energy),
Lab Equipment,Heather Jutila,Vivarium & Biocontainment Systems,
Freezer / Ice machine / Incubators,Melissa Chong (Site Ops)/Heather Jutila (gRED),Vivarium & Biocontainment Systems,
Biological Safety Cabinets,Melissa Chong (Site Ops)/Heather Jutila (gRED),Vivarium & Biocontainment Systems,HVAC
Laboratory Fume Hoods,Melissa Chong (Site Ops)/Heather Jutila (gRED),Vivarium & Biocontainment Systems,BAS
Airflow Monitoring and Alarm System,Heather Jutila,Vivarium & Biocontainment Systems,Building Automation System (BAS)
Auto Sash Operator and Controller,Heather Jutila,Vivarium & Biocontainment Systems,passive infrared sensor (PIR)
RODENT HOUSING EQUIPMENT,Heather Jutila,Vivarium & Biocontainment Systems,Animal Monitoring/Tracking Systems
Individually Ventilated Cage (IVC),Heather Jutila,Vivarium & Biocontainment Systems,HVAC
Animal Transfer Station (ATS),Heather Jutila,Vivarium & Biocontainment Systems,HVAC
CAGE PROCESSING EQUIPMENT,Heather Jutila,Vivarium & Biocontainment Systems,"Animal Watering System, Facility Data Historian (FDH), Fire Alarm, Generator System, Network Lighting Controls, Electrical Control and Monitoring (SCADA)"
Cage & Rack Washer,Heather Jutila,Vivarium & Biocontainment Systems,"Animal Watering System, Facility Data Historian (FDH), Fire Alarm, Generator System, Network Lighting Controls, Electrical Control and Monitoring (SCADA)"
Tunnel Washer,Heather Jutila,Vivarium & Biocontainment Systems,Automated Cage Process System
Automated Soiled (Dirty Side) Bedding Disposal System,Heather Jutila,Vivarium & Biocontainment Systems,"Automated Cage Processing System, Pneumatic Tube Systems"
Automated Fresh (Clean Side) Bedding Dispensing System,Heather Jutila,Vivarium & Biocontainment Systems,"Tunnel Cage Washer, Automated Cage Processing System"
Automated Cage Process System,Heather Jutila,Vivarium & Biocontainment Systems,"Tunnel Washer, Automated Fresh (Clean Side) Bedding Dispensing System"
Robotic Automation System,,Vivarium & Biocontainment Systems,
Automated Bottle Washing and Filling System,Heather Jutila,Vivarium & Biocontainment Systems,
Animal Drinking Water Pouch System,Heather Jutila,Vivarium & Biocontainment Systems,Building Automation System (BAS)
Steam Sterilizer/Dry Heat Sterilizer,Melissa Chong (Site Ops)/Heather Jutila (gRED),Vivarium & Biocontainment Systems,Building Automation System (BAS)
Animal Monitoring/Tracking Systems,Heather Jutila,Vivarium & Biocontainment Systems,Animal Housing Equipment
Animal Feeding System,Heather Jutila,Vivarium & Biocontainment Systems,
Lab Elevator Systems,Melissa Chong,Core Building Autonomy (MEP & Energy),
Passenger Elevators,Melissa Chong,Core Building Autonomy (MEP & Energy),
Service Elevators,Melissa Chong,Core Building Autonomy (MEP & Energy),
Vivarium Elevator Systems,Melissa Chong (Site Ops)/Heather Jutila (gRED),Vivarium & Biocontainment Systems,Facility Data Historian (FDH)
Passenger Elevators (Viv),Melissa Chong (Site Ops)/Heather Jutila (gRED),Vivarium & Biocontainment Systems,
Service Elevators (Viv),Melissa Chong (Site Ops)/Heather Jutila (gRED),Vivarium & Biocontainment Systems,
Power Distribution System,Melissa Chong,Core Building Autonomy (MEP & Energy),Lighting Controls
Lighting Controls,Melissa Chong,Core Building Autonomy (MEP & Energy),"Power Distribution System, Building Automation System (BAS)"
Window Treatments,Melissa Chong,Workplace Experience & Logistics,
Electrified Door Hardware,Philip Moul,"Security, Safety & Health (SSHE)",
Electronic access control system,Philip Moul,"Security, Safety & Health (SSHE)",Electrified Door Hardware
Controlled Environmental Rooms,Melissa Chong,Vivarium & Biocontainment Systems,HVAC Air Distribution
Security Center,Philip Moul,"Security, Safety & Health (SSHE)",
Access Control and Alarm Monitoring (ACAMS),Philip Moul,"Security, Safety & Health (SSHE)",ClearID
Video Surveillance Systems (VSS),Philip Moul,"Security, Safety & Health (SSHE)",
Video Management System (VMS),Philip Moul,"Security, Safety & Health (SSHE)","Genetec Omnicast and AutoVu, Access Control and Alarm Monitoring (ACAMS), Security Communications Systems (SCS)"
Genetec Omnicast and AutoVu,Philip Moul,"Security, Safety & Health (SSHE)",VMS
Network Video Recorders (NVR),Philip Moul,"Security, Safety & Health (SSHE)",
Genetec Stream Vault,Philip Moul,"Security, Safety & Health (SSHE)",
Cameras,Philip Moul,"Security, Safety & Health (SSHE)",
Security Communications Systems (SCS),Philip Moul,"Security, Safety & Health (SSHE)","Access Control and Alarm Monitoring (ACAMS), Video Surveillance Systems (VSS)"
Electronic Security Systems (ESS),Philip Moul,"Security, Safety & Health (SSHE)",
SIP-based IP intercom,Philip Moul,"Security, Safety & Health (SSHE)",
blue light emergency communication devices,Philip Moul,"Security, Safety & Health (SSHE)",
ClearID,,Enterprise IT,"Workday, CIDM, ACAMS and EPP"
Synergis / Alarm Management Platforms,Gautham Sunkara,"Security, Safety & Health (SSHE)","Security Center, ClearID"
Fire Detection and Alarm,Michael Harris,"Security, Safety & Health (SSHE)","water flow switches, elevators, HVAC smoke control, smoke fire dampers, Building Automation System (BAS)"
smoke detectors,Michael Harris,"Security, Safety & Health (SSHE)",
heat detectors,Michael Harris,"Security, Safety & Health (SSHE)",
duct detectors,Michael Harris,"Security, Safety & Health (SSHE)",
audio/visual signaling devices,Michael Harris,"Security, Safety & Health (SSHE)",
manual pull stations,Michael Harris,"Security, Safety & Health (SSHE)",
Gas Detection and Alarm,Michael Harris,"Security, Safety & Health (SSHE)",
Refrigeration Detection and Alarm,,"Security, Safety & Health (SSHE)",
Emergency voice alarm communication system,Philip Moul,"Security, Safety & Health (SSHE)",Fire Alarm
Facility Power Generation,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
emergency Power supply System (EPSS),Melissa Chong,Core Building Autonomy (MEP & Energy),
Battery Energy Storage Systems (BESS),Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Electrical Service and Distribution,Melissa Chong,Core Building Autonomy (MEP & Energy),"Facility Data Historian (FDH), Computerized Maintenance Management System (CMMS)"
Automation Controls and SCADA,Gautham Sunkara,Core Building Autonomy (MEP & Energy),"Building Automation System (BAS), Facility Data Historian (FDH), Generator System"
Electrical Metering/Sub-Metering,Behzad T.,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Power Monitoring Meters,,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Facility Fuel Systems,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Heat Generation,,Core Building Autonomy (MEP & Energy),
Thermal Heat Storage,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Facility Hydronic Distribution,,Core Building Autonomy (MEP & Energy),
Refrigerated & Heating Hot Water System,,Core Building Autonomy (MEP & Energy),
Cyclotron Refrigerated Water System,,Core Building Autonomy (MEP & Energy),
Facility Steam Distribution,Melissa Chong,Core Building Autonomy (MEP & Energy),
HVAC Air Distribution,Melissa Chong,Core Building Autonomy (MEP & Energy),
Exhaust Abatement,Michael Harris,Core Building Autonomy (MEP & Energy),
Cyclotron Exhaust System,Melissa Chong,Core Building Autonomy (MEP & Energy),
H-Occupancy Exhaust Air System,Melissa Chong,Core Building Autonomy (MEP & Energy),
Air Quality Monitoring System,Melissa Chong,"Security, Safety & Health (SSHE)",Building Automation System (BAS)
Temperature sensor,Melissa Chong,"Security, Safety & Health (SSHE)",Building Automation System (BAS)
Relative humidity sensor,Melissa Chong,"Security, Safety & Health (SSHE)",Building Automation System (BAS)
TVOC sensor,Melissa Chong,"Security, Safety & Health (SSHE)",Building Automation System (BAS)
Particulate Matter Sensor,Melissa Chong,"Security, Safety & Health (SSHE)",
Carbon dioxide sensor,Melissa Chong,"Security, Safety & Health (SSHE)",Building Automation System (BAS)
Nitrogen Dioxide Sensor,Melissa Chong,"Security, Safety & Health (SSHE)",
Atmospheric Pressure,Melissa Chong,"Security, Safety & Health (SSHE)",
Light sensor,Melissa Chong,"Security, Safety & Health (SSHE)","Facility Data Historian (FDH), Building Automation System (BAS)"
Occupancy sensor,Melissa Chong,"Security, Safety & Health (SSHE)",
IAQ sensor,Melissa Chong,"Security, Safety & Health (SSHE)",Building Automation System (BAS)
Animal Drinking Water,Heather Jutila,Vivarium & Biocontainment Systems,Building Automation System (BAS)
Autonomous guided vehicle systems,,Scientific Automation & Robotics (Lab),"Access Control and Alarm Monitoring, Elevator Equipment and Controls, Laboratory Robotics"
ABSL-3 Specialized Air Handling,Melissa Chong (Site Ops)/Heather Jutila (gRED),,
Airflow & Pressure Sensors,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
ASRS / Shuttle Systems,,Workplace Experience & Logistics,"Building Automation System (BAS), Digital Integration Platform, Enterprise Resource Platform (ERP)"
Computer Room Air Conditioners (CRAC/CRAH),Melissa Chong,Core Building Autonomy (MEP & Energy),"Intermediate Distribution Frame (IDF), Main Distribution Frame (MDF)"
Controlled Environmental Rooms (HVAC),Melissa Chong,Vivarium & Biocontainment Systems,
Critical Environment Controls,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Leak Detection,Melissa Chong,Core Building Autonomy (MEP & Energy),"Facility Data Historian (FDH), Building Automation System (BAS)"
Backbone Distribution,,Enterprise IT,
Data Integration Layer / APIs,,Enterprise IT,"Animal Monitoring/Tracking Systems, Building Automation System (BAS), Vivarium HVAC"
Mobile Applications,,Enterprise IT,"Animal Monitoring/Tracking Systems, Building Automation System (BAS), Vivarium HVAC"
Analytics & Dashboards,,Enterprise IT,"Animal Monitoring/Tracking Systems, Building Automation System (BAS), Vivarium HVAC"
Smart Building / BMS Platforms,,Enterprise IT,"Animal Monitoring/Tracking Systems, Building Automation System (BAS), Vivarium HVAC"
IoT Device Management Platform,,Enterprise IT,"Animal Monitoring/Tracking Systems, Building Automation System (BAS), Vivarium HVAC"
Collaboration & Meeting Platforms,,Enterprise IT,"Animal Monitoring/Tracking Systems, Building Automation System (BAS), Vivarium HVAC"
Main Distribution Frame (MDF),,Enterprise IT,
Network & Security Platforms,,Enterprise IT,
Wireless Networks,,Enterprise IT,
Secure Vendor / Remote Access,,Enterprise IT,
Network Monitoring & Redundancy,,Enterprise IT,
Non-Potable Reclaim Water,Behzad T.,Core Building Autonomy (MEP & Energy),
Facility Data Historian (FDH),Gautham Sunkara,Digital Integration & Platform,Building Automation System (BAS)
Processed Water/Water Treatment,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Domestic/Industrial Water Distribution,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Janitorial & Office Supply Flow,Melissa Chong,Workplace Experience & Logistics,"Supply Chain Procurement, CMMS, IWMS, ERP"
Gas Systems,Melissa Chong,Core Building Autonomy (MEP & Energy),
Carbon Dioxide,Melissa Chong,Core Building Autonomy (MEP & Energy),BAS
Helium Recovery System,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Gaseous Nitrogen,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Liquid Nitrogen,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Oxygen,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Specialty Gases,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Hydrogen,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Chemical Waste Systems,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Laboratory and Vivarium Vacuum,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Lab and Vivarium Compressed Air,Melissa Chong,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Processed Water Systems,Melissa Chong,Core Building Autonomy (MEP & Energy),
Reagent Stores & Solvent Dispensing,Melissa Chong,Scientific Automation & Robotics (Lab),"Building Automation System (BAS), Door Interlock Systems, Supply Chain Procurement, LIMS"
Water Metering/Sub-Metering,Behzad T.,Core Building Autonomy (MEP & Energy),Building Automation System (BAS)
Campus Lockdown System,Philip Moul,"Security, Safety & Health (SSHE)",Access Control and Alarm Monitoring
Pre-order kiosks,,Workplace Experience & Logistics,Retail and Service Equipment
Gaseous Decontamination Chambers,Melissa Chong,Vivarium & Biocontainment Systems,
Fault Detection / Preventative Maintenance,Melissa Chong,Core Building Autonomy (MEP & Energy),CMMS
Laboratory Sterilizers,Melissa Chong (Site Ops)/Heather Jutila (gRED),Scientific Automation & Robotics (Lab),Building Automation System (BAS)
Employee Health Pods,,Workplace Experience & Logistics,
Personal Lockers,,Workplace Experience & Logistics,
Wayfinding,,Workplace Experience & Logistics,
Weapons Detection,Philip Moul,"Security, Safety & Health (SSHE)",
Access Code Governance,Philip Moul,Security,
Vehicle Charging Equipment (EV),,Workplace Experience & Logistics,
Valet System,,Workplace Experience & Logistics,
Sound Masking,,Workplace Experience & Logistics,
Location Tracking Systems (RTLS),Philip Moul,Workplace Experience & Logistics,
Vivarium Hygiene Barrier Access,Heather Jutila,Vivarium & Biocontainment Systems,
Vivarium Logistics & Management,Melissa Chong (Site Ops)/Heather Jutila (gRED),Vivarium & Biocontainment Systems,CMMS
Vivarium Waste Management,,Vivarium & Biocontainment Systems,
ESG Platform,Michael Harris,Core Building Autonomy (MEP & Energy),
Mail Room Management,Jozef Bolech,Workplace Experience & Logistics,
Asset Management,Melissa Chong,Workplace Experience & Logistics,CMMS
IWMS / CMMS,Melissa Chong,Core Building Autonomy (MEP & Energy),
Drone & Robot Security Patrols,,"Security, Safety & Health (SSHE)",
Emergency Services Staging,Philip Moul,"Security, Safety & Health (SSHE)",
Stormwater Control System,Michael Harris,Core Building Autonomy (MEP & Energy),
Aquatics Environmental Support,Heather Jutila,Vivarium & Biocontainment Systems,
Master Clock Systems,Heather Jutila,Scientific Automation & Robotics (Lab),
Air Handler Units (AHUs),Melissa Chong,Core Building Autonomy (MEP & Energy),BAS
Airflow & Pressure Sensors (HVAC),Melissa Chong,Core Building Autonomy (MEP & Energy),BAS`;

function parseCSV(raw) {
  const lines = raw.trim().split('\n');
  const data = [];
  for (let i = 1; i < lines.length; i++) {
    const row = [];
    let cur = '', inQuotes = false;
    for (let j = 0; j < lines[i].length; j++) {
      const ch = lines[i][j];
      if (ch === '"') { inQuotes = !inQuotes; }
      else if (ch === ',' && !inQuotes) { row.push(cur.trim()); cur = ''; }
      else { cur += ch; }
    }
    row.push(cur.trim());
    data.push(row);
  }
  return data;
}

const rows = parseCSV(CSV_RAW);

const CAT_COLORS = {
  "Core Building Autonomy (MEP & Energy)": "#E8735A",
  "Digital Integration & Platform": "#6C8EBF",
  "Enterprise IT": "#8B6DAF",
  "Scientific Automation & Robotics (Lab)": "#D4A843",
  "Security": "#5BA08A",
  "Security, Safety & Health (SSHE)": "#5BA08A",
  "Vivarium & Biocontainment Systems": "#C47AB3",
  "Workplace Experience & Logistics": "#7EAED4",
  "": "#555"
};

// Build systems array
const systems = rows.map((r, i) => ({
  idx: i,
  name: r[0] || '',
  owner: r[1] || '',
  category: r[2] || 'Uncategorized',
  reqRaw: r[3] || '',
  hasRequired: !!(r[3] && r[3].trim().length > 0)
}));

// ─── BUILD EDGES by name-matching ────────────────────────────────
// Create a lookup from system name (lowercased) to index
const nameLookup = {};
systems.forEach((s, i) => {
  const key = s.name.toLowerCase().trim();
  nameLookup[key] = i;
});
// Also add common abbreviations
const aliases = {
  'bas': 0, 'building automation system': 0, 'building automtion system': 0, 'building automtion system (bas)': 0,
};
systems.forEach((s, i) => {
  // add short forms
  const n = s.name.toLowerCase().trim();
  if (!aliases[n]) aliases[n] = i;
});

function findSystemIndex(text) {
  const t = text.toLowerCase().trim();
  // Direct match
  if (nameLookup[t] !== undefined) return nameLookup[t];
  if (aliases[t] !== undefined) return aliases[t];
  // Partial match - find system whose name contains this text or vice versa
  for (const [key, idx] of Object.entries(nameLookup)) {
    if (key.includes(t) || t.includes(key)) return idx;
  }
  return -1;
}

const EDGES = [];
const edgeSet = new Set();
systems.forEach((sys, i) => {
  if (!sys.reqRaw) return;
  // Split on comma but be careful of quoted sections
  const parts = sys.reqRaw.split(/,\s*(?![^()]*\))/);
  parts.forEach(part => {
    const cleaned = part.replace(/^and\s+/i, '').trim();
    if (!cleaned) return;
    const targetIdx = findSystemIndex(cleaned);
    if (targetIdx >= 0 && targetIdx !== i) {
      const key = `${Math.min(i, targetIdx)}-${Math.max(i, targetIdx)}`;
      if (!edgeSet.has(key)) {
        edgeSet.add(key);
        EDGES.push([i, targetIdx]);
      }
    }
  });
});

// Connection counts
const connCount = {};
EDGES.forEach(([s, t]) => {
  connCount[s] = (connCount[s] || 0) + 1;
  connCount[t] = (connCount[t] || 0) + 1;
});

// Categories
const catSet = new Set(systems.map(s => s.category));
const categories = [...catSet].filter(c => c && c !== 'Uncategorized').sort();

// ─── STATE ───────────────────────────────────────────────────────
let filterCat = 'All';
let filterOwner = 'All';
let reqOnly = false;
let highlightSystem = null;

const svg = document.getElementById('main-svg');
const tooltip = document.getElementById('tooltip');
const NS = 'http://www.w3.org/2000/svg';

// ─── LAYOUT ──────────────────────────────────────────────────────
function hexPath(cx, cy, r) {
  const pts = [];
  for (let i = 0; i < 6; i++) {
    const a = (Math.PI / 3) * i - Math.PI / 6;
    pts.push(`${cx + r * Math.cos(a)},${cy + r * Math.sin(a)}`);
  }
  return `M ${pts.join(' L ')} Z`;
}

function render() {
  svg.innerHTML = '';
  const container = document.getElementById('canvas-container');
  const W = container.clientWidth;
  const H = container.clientHeight;
  // Shift center right to visually center between legend right edge and page right edge
  const legendEl = document.getElementById('legend');
  const legendW = legendEl ? legendEl.offsetWidth + 16 : 0; // legend width + left margin
  const cx = legendW + (W - legendW) / 2;
  const cy = H / 2;

  // Filter systems
  let visible = systems.filter(s => {
    if (filterCat !== 'All' && s.category !== filterCat) return false;
    if (filterOwner !== 'All' && s.owner !== filterOwner) return false;
    if (reqOnly && !s.hasRequired) return false;
    return true;
  });

  // Group by category
  const byCat = {};
  visible.forEach(s => {
    if (!byCat[s.category]) byCat[s.category] = [];
    byCat[s.category].push(s);
  });
  const catKeys = Object.keys(byCat).sort();
  const totalSystems = visible.length;

  if (totalSystems === 0) {
    return;
  }

  // Defs
  const defs = document.createElementNS(NS, 'defs');
  const rg = document.createElementNS(NS, 'radialGradient');
  rg.id = 'bgGlow';
  rg.innerHTML = '<stop offset="0%" stop-color="#151530" /><stop offset="100%" stop-color="#0d0d1a" />';
  defs.appendChild(rg);
  const flt = document.createElementNS(NS, 'filter');
  flt.id = 'glow';
  flt.innerHTML = '<feGaussianBlur stdDeviation="2.5" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>';
  defs.appendChild(flt);
  svg.appendChild(defs);

  // BG
  const bg = document.createElementNS(NS, 'rect');
  bg.setAttribute('width', W); bg.setAttribute('height', H);
  bg.setAttribute('fill', 'url(#bgGlow)');
  svg.appendChild(bg);

  // Guide rings
  const gGuides = document.createElementNS(NS, 'g');
  [0.12, 0.22, 0.32, 0.42].forEach(frac => {
    const r = Math.min(W, H) * frac;
    const c = document.createElementNS(NS, 'circle');
    c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', r);
    c.setAttribute('fill', 'none'); c.setAttribute('stroke', '#1a1a34');
    c.setAttribute('stroke-width', '0.5'); c.setAttribute('stroke-dasharray', '2,5');
    gGuides.appendChild(c);
  });
  svg.appendChild(gGuides);

  // Category arc segments
  const gap = 0.06;
  const totalGap = gap * catKeys.length;
  const avail = 2 * Math.PI - totalGap;
  const ringR = Math.min(W, H) * 0.14;
  const segments = [];
  let angle = -Math.PI / 2;
  catKeys.forEach(cat => {
    const frac = byCat[cat].length / totalSystems;
    const span = frac * avail;
    segments.push({ cat, start: angle, end: angle + span, systems: byCat[cat] });
    angle += span + gap;
  });

  const gArcs = document.createElementNS(NS, 'g');
  segments.forEach(seg => {
    const path = document.createElementNS(NS, 'path');
    const r = ringR;
    const x1 = cx + r * Math.cos(seg.start), y1 = cy + r * Math.sin(seg.start);
    const x2 = cx + r * Math.cos(seg.end), y2 = cy + r * Math.sin(seg.end);
    const large = (seg.end - seg.start) > Math.PI ? 1 : 0;
    path.setAttribute('d', `M ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2}`);
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke', CAT_COLORS[seg.cat] || '#555');
    path.setAttribute('stroke-width', 8);
    path.setAttribute('stroke-linecap', 'round');
    path.setAttribute('opacity', '0.25');
    gArcs.appendChild(path);

    // Category label
    const mid = (seg.start + seg.end) / 2;
    const lr = ringR - 18;
    const lx = cx + lr * Math.cos(mid), ly = cy + lr * Math.sin(mid);
    const txt = document.createElementNS(NS, 'text');
    txt.setAttribute('x', lx); txt.setAttribute('y', ly);
    txt.setAttribute('fill', CAT_COLORS[seg.cat] || '#888');
    txt.setAttribute('font-size', '7'); txt.setAttribute('font-weight', '600');
    txt.setAttribute('text-anchor', 'middle'); txt.setAttribute('dominant-baseline', 'middle');
    txt.setAttribute('opacity', '0.5');
    const shortName = seg.cat.length > 22 ? seg.cat.replace(/ & /g, '/').replace(/\(.*?\)/g, '').trim().slice(0, 20) + '…' : seg.cat;
    txt.textContent = shortName;
    const deg = mid * (180 / Math.PI);
    const flip = deg > 90 || deg < -90;
    txt.setAttribute('transform', `rotate(${flip ? deg + 180 : deg}, ${lx}, ${ly})`);
    gArcs.appendChild(txt);
  });
  svg.appendChild(gArcs);

  // ─── POSITION NODES: most-connected → inner ring ───────────────
  const nodePositions = {};
  const innerR = ringR + 22;
  const outerR = Math.min(W, H) * 0.46;

  segments.forEach(seg => {
    // Sort by connection count DESC — most connected goes to inner ring
    const sorted = [...seg.systems].sort((a, b) => (connCount[b.idx] || 0) - (connCount[a.idx] || 0));

    const angSpan = seg.end - seg.start;
    const n = sorted.length;
    const rings = n > 14 ? 4 : n > 8 ? 3 : n > 4 ? 2 : 1;
    const perRing = Math.ceil(n / rings);

    sorted.forEach((s, i) => {
      const ring = Math.floor(i / perRing);
      const idxInRing = i - ring * perRing;
      const countInRing = Math.min(perRing, n - ring * perRing);

      const r = innerR + (outerR - innerR) * (ring / Math.max(1, rings - 0.3));
      const angPad = 0.015;
      const a = seg.start + angPad + (angSpan - 2 * angPad) * ((idxInRing + 0.5) / countInRing);

      const cc = connCount[s.idx] || 0;
      const baseR = Math.max(10, Math.min(18, 8 + cc * 1.1));

      nodePositions[s.idx] = { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a), r: baseR };
    });
  });

  // ─── DRAW EDGES ────────────────────────────────────────────────
  const gLines = document.createElementNS(NS, 'g');
  EDGES.forEach(([si, ti]) => {
    const sp = nodePositions[si], tp = nodePositions[ti];
    if (!sp || !tp) return;
    const isHighlit = highlightSystem === null || highlightSystem === si || highlightSystem === ti;
    const sameCat = systems[si].category === systems[ti].category;

    if (sameCat) {
      const line = document.createElementNS(NS, 'line');
      line.setAttribute('x1', sp.x); line.setAttribute('y1', sp.y);
      line.setAttribute('x2', tp.x); line.setAttribute('y2', tp.y);
      line.setAttribute('stroke', CAT_COLORS[systems[si].category] || '#444');
      line.setAttribute('stroke-width', isHighlit ? 1.2 : 0.4);
      line.setAttribute('stroke-opacity', isHighlit ? (highlightSystem !== null ? 0.55 : 0.12) : 0.02);
      line.classList.add('connection-line');
      gLines.appendChild(line);
    } else {
      const mx = cx + (sp.x + tp.x - 2 * cx) * 0.15;
      const my = cy + (sp.y + tp.y - 2 * cy) * 0.15;
      const path = document.createElementNS(NS, 'path');
      path.setAttribute('d', `M ${sp.x} ${sp.y} Q ${mx} ${my} ${tp.x} ${tp.y}`);
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', '#4a4a6a');
      path.setAttribute('stroke-width', isHighlit ? 1 : 0.3);
      path.setAttribute('stroke-opacity', isHighlit ? (highlightSystem !== null ? 0.45 : 0.1) : 0.02);
      path.setAttribute('stroke-dasharray', '3,3');
      path.classList.add('connection-line');
      gLines.appendChild(path);
    }
  });
  svg.appendChild(gLines);

  // ─── DRAW NODES ────────────────────────────────────────────────
  const gNodes = document.createElementNS(NS, 'g');
  Object.entries(nodePositions).forEach(([idx, pos]) => {
    const i = parseInt(idx);
    const sys = systems[i];
    if (!sys) return;

    const isHighlit = highlightSystem === null || highlightSystem === i ||
      EDGES.some(([s, t]) => (s === highlightSystem && t === i) || (t === highlightSystem && s === i));

    const cc = connCount[i] || 0;
    const g = document.createElementNS(NS, 'g');
    g.classList.add('hex-node');
    g.style.opacity = isHighlit ? 1 : (highlightSystem !== null ? 0.1 : 1);

    const hex = document.createElementNS(NS, 'path');
    hex.setAttribute('d', hexPath(pos.x, pos.y, pos.r));
    hex.setAttribute('fill', (CAT_COLORS[sys.category] || '#555') + '30');

    // BORDER: only show if system has required connections
    if (sys.hasRequired) {
      hex.setAttribute('stroke', CAT_COLORS[sys.category] || '#555');
      hex.setAttribute('stroke-width', 1.5);
      hex.setAttribute('stroke-opacity', '0.85');
    } else {
      hex.setAttribute('stroke', 'none');
    }
    g.appendChild(hex);

    // Label
    const label = document.createElementNS(NS, 'text');
    label.setAttribute('x', pos.x);
    label.setAttribute('y', pos.y + 1);
    label.setAttribute('fill', '#ccc');
    label.setAttribute('font-size', pos.r > 14 ? '6.5' : '5.5');
    label.setAttribute('font-weight', '500');
    label.setAttribute('text-anchor', 'middle');
    label.setAttribute('dominant-baseline', 'middle');
    const maxLen = 18;
    const short = sys.name.length > maxLen ? sys.name.slice(0, maxLen - 2) + '…' : sys.name;
    label.textContent = short;
    g.appendChild(label);

    attachNodeEvents(g, sys, pos);
    gNodes.appendChild(g);
  });
  svg.appendChild(gNodes);


}

function attachNodeEvents(el, sys, pos) {
  el.addEventListener('mouseenter', (e) => {
    const cc = connCount[sys.idx] || 0;
    const connectedTo = EDGES
      .filter(([s, t]) => s === sys.idx || t === sys.idx)
      .map(([s, t]) => systems[s === sys.idx ? t : s]?.name)
      .filter(Boolean).slice(0, 6);

    tooltip.innerHTML = `
      <div class="tt-name" style="color:${CAT_COLORS[sys.category] || '#ccc'}">${sys.name}</div>
      <div class="tt-cat">${sys.category}</div>
      <div class="tt-row"><span class="tt-label">Owner</span><span class="tt-val">${sys.owner || '—'}</span></div>
      <div class="tt-row"><span class="tt-label">Connections</span><span class="tt-val">${cc}</span></div>
      ${connectedTo.length ? '<div class="tt-row"><span class="tt-label">Connected to</span><span class="tt-val">' + connectedTo.join(', ') + (cc > 6 ? '…' : '') + '</span></div>' : ''}
      ${sys.hasRequired ? '<div class="tt-req">◆ Has Required Connections</div>' : ''}
    `;
    tooltip.classList.add('visible');
  });
  el.addEventListener('mousemove', (e) => {
    tooltip.style.left = (e.clientX + 14) + 'px';
    tooltip.style.top = (e.clientY - 10) + 'px';
  });
  el.addEventListener('mouseleave', () => tooltip.classList.remove('visible'));
  el.addEventListener('click', () => {
    highlightSystem = highlightSystem === sys.idx ? null : sys.idx;
    render();
  });
}

// ─── LEGEND ──────────────────────────────────────────────────────
const legend = document.getElementById('legend');
legend.innerHTML = '<div class="legend-title">Categories</div>' +
  categories.map(c => {
    const cnt = systems.filter(s => s.category === c).length;
    return '<div class="legend-item" data-cat="' + c + '">' +
      '<div class="swatch" style="background:' + (CAT_COLORS[c] || '#555') + '"></div>' +
      '<span>' + (c.length > 30 ? c.slice(0, 28) + '…' : c) + '</span>' +
      '</div>';
  }).join('');
legend.querySelectorAll('.legend-item').forEach(el => {
  el.addEventListener('click', () => {
    const cat = el.dataset.cat;
    filterCat = filterCat === cat ? 'All' : cat;
    highlightSystem = null;
    render();
  });
});

// ─── INIT ────────────────────────────────────────────────────────
render();
window.addEventListener('resize', render);
</script>
</body>
</html>
